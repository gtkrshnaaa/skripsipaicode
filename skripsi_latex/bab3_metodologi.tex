% Chapter 3 - Metodologi Penelitian
\chapter{Metodologi Penelitian}
\label{chap:metodologi}

\section{Metode Pengembangan}
Penelitian ini menggunakan pendekatan \textit{Research and Development} (R\&D) dengan strategi \textit{prototyping} iteratif. Pendekatan tersebut dipilih karena kebutuhan eksplorasi desain agen AI yang bersifat \textit{stateful} dan interaktif, sehingga memerlukan siklus cepat: perancangan, implementasi, uji coba, dan perbaikan. Setiap iterasi menghasilkan artefak yang dapat diuji untuk memvalidasi asumsi dan menyempurnakan rancangan.

\section{Arsitektur Sistem}
Arsitektur Paicode dirancang modular dan berlapis, dengan pembagian tanggung jawab yang jelas:

\begin{itemize}
  \item \textbf{Antarmuka CLI (\texttt{cli.py})}: titik masuk perintah \texttt{pai} dan pengelola argumen (subperintah \texttt{auto}, \texttt{config}). Mendukung parameter \texttt{--model} dan \texttt{--temperature} untuk konfigurasi runtime LLM. Secara default, CLI memanggil sesi interaktif agen.
  \item \textbf{Agen (\texttt{agent.py})}: mengimplementasikan \textit{Single-Shot Intelligence} yang mencakup: (1) klasifikasi intensi (\textit{chat} vs \textit{task}), (2) \textit{acknowledgment} dinamis, (3) fase perencanaan untuk analisis mendalam dalam format JSON, (4) fase eksekusi adaptif dengan 1-3 subfase berdasarkan kompleksitas, dan (5) saran langkah berikutnya. Menyediakan 10 perintah: \texttt{READ}, \texttt{WRITE}, \texttt{MODIFY}, \texttt{TREE}, \texttt{LIST\_PATH}, \texttt{MKDIR}, \texttt{TOUCH}, \texttt{RM}, \texttt{MV}, \texttt{FINISH}. Mengelola memori percakapan dengan pencatatan sesi ke \texttt{.pai\_history}.
  \item \textbf{Jembatan LLM (\texttt{llm.py})}: menangani konfigurasi API Gemini dengan manajemen API key tunggal. Membersihkan output dari markdown artifacts, menyediakan status spinner saat LLM berpikir, dan mengoptimalkan penggunaan token dengan sistem 2-panggilan API.
  \item \textbf{Manajemen Konfigurasi (\texttt{config.py})}: menyimpan dan mengelola API key tunggal dalam format JSON di \texttt{~/.config/pai-code/credentials.json} dengan izin berkas 600. Mendukung operasi: \texttt{set}, \texttt{show}, \texttt{remove}, \texttt{validate}, dan migrasi otomatis dari sistem multi-key.
  \item \textbf{Pengatur Workspace (\texttt{workspace.py})}: bertindak sebagai \emph{workspace controller} yang menyediakan fungsi-fungsi terpusat untuk menjalankan operasi tingkat-aplikasi pada ruang kerja proyek. Sebelum aksi dieksekusi, modul ini menegakkan kebijakan \textit{path security} (normalisasi, verifikasi akar, dan deny-list direktori sensitif seperti \texttt{.env}, \texttt{.git}, \texttt{venv}, \texttt{\_\_pycache\_\_}, \texttt{.pai\_history}, \texttt{.idea}, \texttt{.vscode}). Sistem modifikasi berbasis \textit{diff} dengan threshold 500 baris dan ratio maksimal 50\% (dapat dikonfigurasi via \texttt{PAI\_MODIFY\_THRESHOLD} dan \texttt{PAI\_MODIFY\_MAX\_RATIO}) mencegah penimpaan berkas tidak diinginkan dengan atomic write menggunakan tempfile.
  \item \textbf{Tampilan Terminal (\texttt{ui.py})}: penyajian hasil eksekusi menggunakan \texttt{rich} (panel, warna, tabel, penyorotan sintaks, spinner status). Mendukung \texttt{prompt\_toolkit} (opsional) untuk input multiline yang lebih baik.
\end{itemize}

Alur data tipikal dengan \textit{Single-Shot Intelligence}: masukan pengguna (CLI) → klasifikasi intensi → \textit{acknowledgment} dinamis → fase perencanaan (analisis JSON) → fase eksekusi adaptif (1-3 subfase) → saran langkah berikutnya → pencatatan konteks sebagai memori percakapan.

\section{Visualisasi Metodologi}
Bagian ini menyajikan visualisasi konsep menggunakan tabel dan daftar terstruktur berbasis LaTeX.

% Tabel 3.1: Diagram modul dan dependensi
\begin{longtable}{@{}p{0.25\textwidth}p{0.70\textwidth}@{}}
  \caption{Modul dan Dependensi Komponen Paicode}\label{tab:diagram-modul}\\
  \toprule
  \textbf{Komponen} & \textbf{Deskripsi dan Dependensi Utama} \\
  \midrule
  \endfirsthead
  \toprule
  \textbf{Komponen} & \textbf{Deskripsi dan Dependensi Utama} \\
  \midrule
  \endhead
  CLI (\texttt{cli.py}) & Titik masuk perintah, parsing argumen (\texttt{--model}, \texttt{--temperature}); memanggil sesi agen. Bergantung pada modul \texttt{agent}, \texttt{config}, dan \texttt{llm}. \\
  Agen (\texttt{agent.py}) & Implementasi \textit{Single-Shot Intelligence}: klasifikasi intensi, \textit{acknowledgment} dinamis, fase perencanaan JSON, fase eksekusi adaptif (1-3 subfase), dan saran langkah berikutnya. Mengelola memori percakapan, \textit{interrupt handling} (Ctrl+C), dan pencatatan sesi ke \texttt{.pai\_history}. Menyediakan 10 perintah workspace. Memanggil \texttt{llm}, \texttt{workspace}, \texttt{ui}. \\
  LLM Bridge (\texttt{llm.py}) & Integrasi Gemini API (\texttt{google-generativeai}) dengan manajemen API key tunggal. Membersihkan markdown artifacts dari output LLM dan mengoptimalkan penggunaan token. Mengambil API key dari \texttt{config}. \\
  Konfigurasi (\texttt{config.py}) & Manajemen API key tunggal dalam format JSON di \texttt{~/.config/pai-code/credentials.json}. Operasi: \texttt{set}, \texttt{show}, \texttt{remove}, \texttt{validate}, dan migrasi otomatis dari sistem multi-key. \\
  Pengatur Workspace (\texttt{workspace.py}) & \emph{Workspace controller} dengan fungsi operasi workspace (baca/tulis, buat/hapus/pindah, tree/list path). Sistem modifikasi berbasis \textit{diff} dengan threshold 500 baris dan ratio maksimal 50\% (konfigurabel via environment variables) serta atomic write. Penegakan \textit{path security} dengan deny-list 7 pola sensitif (\texttt{.env}, \texttt{.git}, \texttt{venv}, dll). \\
  Terminal UI (\texttt{ui.py}) & Komponen TUI berbasis \texttt{rich}: panel, tema, syntax highlighting, tabel, spinner. Dukungan opsional \texttt{prompt\_toolkit} untuk input multiline yang lebih baik. \\
  \bottomrule
\end{longtable}

Pada Tabel~\ref{tab:diagram-modul} ditunjukkan komponen utama dan interkoneksinya, sebagai acuan implementasi.

% Tabel 3.2: Urutan interaksi (sequence) sesi agen dengan Single-Shot Intelligence
\begin{longtable}{@{}p{0.06\textwidth}p{0.18\textwidth}p{0.70\textwidth}@{}}
  \caption{Urutan Interaksi Sesi Agen dengan Single-Shot Intelligence}\label{tab:sequence-session}\\
  \toprule
  \textbf{No} & \textbf{Pelaku} & \textbf{Aksi/Peristiwa} \\
  \midrule
  \endfirsthead
  \toprule
  \textbf{No} & \textbf{Pelaku} & \textbf{Aksi/Peristiwa} \\
  \midrule
  \endhead
  1 & Pengguna & Memberikan tujuan/permintaan tingkat tinggi di terminal. \\
  2 & CLI & Meneruskan masukan ke agen; menyiapkan konteks sesi. \\
  3 & Agen & Melakukan klasifikasi intensi (\textit{chat} vs \textit{task}) menggunakan LLM. Jika \textit{chat}, langsung berikan respons dan kembali ke langkah 1. \\
  4 & Agen & \textbf{Acknowledgment Dinamis}: Memberikan respons awal untuk mengakui dan memahami permintaan pengguna. \\
  5 & LLM & \textbf{Fase Perencanaan}: Melakukan analisis mendalam dan menghasilkan perencanaan komprehensif dalam format JSON dengan detail eksekusi. \\
  6 & Agen & Menampilkan hasil perencanaan dalam panel terstruktur dan memberikan konfirmasi sebelum eksekusi. \\
  7 & LLM & \textbf{Fase Eksekusi Adaptif}: Menentukan jumlah subfase (1-3) berdasarkan kompleksitas, kemudian melaksanakan implementasi cerdas. \\
  8 & Workspace/UI & Menjalankan operasi berkas (\texttt{READ}, \texttt{WRITE}, \texttt{MODIFY}, dll.) dengan \textit{path security} dan sistem \textit{diff}-aware, menampilkan hasil di terminal. \\
  9 & Agen & Memberikan status akhir (sukses/gagal) dan saran langkah berikutnya jika diperlukan. \\
  10 & Agen & Mencatat seluruh interaksi ke \texttt{.pai\_history/session\_YYYYMMDD\_HHMMSS.log} sebagai memori (\emph{stateful}). \\
  11 & Pengguna & Memberikan instruksi lanjutan; siklus berulang sampai \texttt{exit/quit}. \\
  \bottomrule
\end{longtable}

Pada Tabel~\ref{tab:sequence-session} divisualisasikan aliran pesan yang terjadi selama satu putaran iterasi agen.

% Tabel/Daftar 3.3: Alur kebijakan keamanan path
\paragraph{Alur Kebijakan Keamanan \textit{Path}.} Langkah-langkah validasi \textit{path} diringkas berikut:
\begin{enumerate}[label=\arabic*.]
  \item Normalisasi \textit{path} target (\texttt{os.path.normpath}).
  \item Resolusi \textit{real path} relatif terhadap akar proyek; pastikan tetap berada di dalam akar proyek.
  \item Pemeriksaan \emph{deny-list} direktori/berkas sensitif: \texttt{.env}, \texttt{.git}, \texttt{venv}, \texttt{\_\_pycache\_\_}, \texttt{.pai\_history}, \texttt{.idea}, \texttt{.vscode}.
  \item Jika salah satu pemeriksaan gagal: batalkan operasi dan tampilkan pesan kesalahan.
\end{enumerate}

\begin{longtable}{@{}p{0.20\textwidth}p{0.74\textwidth}@{}}
  \caption{Rangkuman Validasi Keamanan \textit{Path}}\label{tab:policy-keamanan}\\
  \toprule
  \textbf{Tahap} & \textbf{Detail Pemeriksaan} \\
  \midrule
  \endfirsthead
  \toprule
  \textbf{Tahap} & \textbf{Detail Pemeriksaan} \\
  \midrule
  \endhead
  Normalisasi & Gunakan fungsi normalisasi untuk menyingkirkan segmen berlebih (mis. \texttt{..}, duplikasi pemisah). \\
  Verifikasi Root & Gabungkan terhadap akar proyek, lakukan \texttt{realpath}, dan validasi prefiks tetap di dalam akar proyek. \\
  Deny-list & Tolak bila salah satu segmen \textit{path} termasuk daftar sensitif (.env, .git, venv, dll.). \\
  Penanganan Error & Batalkan operasi dan tampilkan pesan kesalahan yang informatif melalui TUI. \\
  \bottomrule
\end{longtable}

Pada Tabel~\ref{tab:policy-keamanan} diperlihatkan langkah-langkah validasi \textit{path} sebagai pengaman operasi berkas proyek.

\section{Alat dan Lingkungan}
Lingkungan dan alat yang digunakan:

\begin{itemize}
  \item Sistem operasi: Ubuntu (Linux).
  \item Bahasa pemrograman: Python (\texttt{\textgreater= 3.10}).
  \item Manajer dependensi: pip dan virtual environment; instalasi otomatis melalui Makefile dengan entry point CLI melalui skrip launcher di \texttt{\$HOME/.local/bin/pai}.
  \item LLM: Google Gemini (model \texttt{gemini-2.5-flash-lite}, dapat dikonfigurasi via \texttt{PAI\_MODEL}) melalui paket \texttt{google-generativeai} versi $\geq$ 0.5.4.
  \item TUI: \texttt{rich} (versi $\geq$ 13.7.1) untuk panel, warna, tabel, penyorotan sintaks, dan spinner status; \texttt{prompt\_toolkit} (versi $\geq$ 3.0.43, opsional) untuk input multiline yang lebih baik.
  \item Dependensi tambahan: \texttt{Pygments} ($\geq$ 2.16.0) untuk syntax highlighting.
  \item Variabel lingkungan: \texttt{PAI\_MODEL}, \texttt{PAI\_TEMPERATURE}, \texttt{PAI\_MODIFY\_THRESHOLD}, \texttt{PAI\_MODIFY\_MAX\_RATIO}, dan variabel untuk menekan log gRPC/absl yang berisik.
  \item LaTeX: TeX Live (\texttt{texlive-latex-recommended}, \texttt{texlive-latex-extra}, dsb.) dan Makefile untuk kompilasi naskah.
  \item Kendali versi: Git dan GitHub.
\end{itemize}

\section{Prosedur Penelitian}
Prosedur penelitian dan evaluasi dirancang sebagai berikut:

\begin{enumerate}
  \item \textbf{Perancangan}: mendefinisikan skenario penggunaan, himpunan perintah agen, dan kebijakan keamanan \textit{path}.
  \item \textbf{Implementasi}: membangun modul-modul inti (CLI, Agen, LLM, Workspace, UI) berikut mekanisme \textit{diff}-aware untuk pembatasan perubahan.
  \item \textbf{Eksperimen}: menjalankan serangkaian skenario pemrograman (mis. pembuatan struktur proyek, pembuatan/ pembacaan/ modifikasi berkas, refaktorisasi sederhana) dalam sesi interaktif.
  \item \textbf{Pengumpulan Data}: merekam waktu penyelesaian tugas, jumlah langkah perintah, tingkat keberhasilan eksekusi, dan catatan kesalahan.
  \item \textbf{Evaluasi}: membandingkan hasil dengan proses manual atau alat pembanding bila relevan, menggunakan metrik: (i) efisiensi (waktu dan langkah), (ii) ketepatan hasil (kompilasi/eksekusi kode), (iii) keamanan (kegagalan akses \textit{path} sensitif), dan (iv) pengalaman pengguna (keterbacaan output).
  \item \textbf{Analisis}: mengidentifikasi kelebihan, kekurangan, dan peluang peningkatan (mis. dukungan multi-LLM, integrasi editor, perluasan kebijakan keamanan).
\end{enumerate}
